name: XServer GAME å®Œå…¨è‡ªåŠ¨åŒ–ç™»å½•

on:
  schedule:
    # æ¯8å°æ—¶è¿è¡Œä¸€æ¬¡ (UTCæ—¶é—´: 0:00, 8:00, 16:00)
    - cron: '0 */8 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      debug_mode:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼ (ä¿ç•™æ›´å¤šæ—¥å¿—)'
        required: false
        default: false
        type: boolean

jobs:
  auto-login:
    runs-on: ubuntu-22.04
    
    # æˆäºˆå·¥ä½œæµå†™å…¥ä»“åº“å†…å®¹çš„æƒé™
    permissions:
      contents: write
      actions: write
    
    # è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º20åˆ†é’Ÿ (åŒ…å«é‚®ç®±éªŒè¯ç è·å–æ—¶é—´)
    timeout-minutes: 20
    
    steps:
    - name: ğŸ”„ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ­ å®‰è£… Chrome æµè§ˆå™¨å’Œæ—¥æ–‡å­—ä½“
      run: |
        # æ›´æ–°åŒ…åˆ—è¡¨
        sudo apt-get update
        
        # å®‰è£…æ—¥æ–‡å­—ä½“åŒ…ï¼Œæ”¯æŒæ—¥æ–‡æ˜¾ç¤º
        sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
        
        # å®‰è£…Chromeæµè§ˆå™¨ (undetected-chromedriverä¼šè‡ªåŠ¨ç®¡ç†é©±åŠ¨)
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # éªŒè¯å­—ä½“å®‰è£…
        echo "ğŸ“ å·²å®‰è£…çš„æ—¥æ–‡å­—ä½“ï¼š"
        fc-list | grep -i "noto.*cjk" | head -5
        
    - name: ğŸš€ è¿è¡Œ XServer å®Œå…¨è‡ªåŠ¨åŒ–ç™»å½•
      env:
        # XServer ç™»å½•å‡­æ® (main.pyä¼šè‡ªåŠ¨è¯»å–è¿™äº›ç¯å¢ƒå˜é‡)
        XSERVER_EMAIL: ${{ secrets.XSERVER_EMAIL }}
        XSERVER_PASSWORD: ${{ secrets.XSERVER_PASSWORD }}
        
        # é‚®ç®±éªŒè¯ç è·å–å‡­æ® (main.pyä¼šè‡ªåŠ¨è¯»å–è¿™äº›ç¯å¢ƒå˜é‡)
        WEBMAIL_USERNAME: ${{ secrets.WEBMAIL_USERNAME }}
        WEBMAIL_PASSWORD: ${{ secrets.WEBMAIL_PASSWORD }}
        
        # è°ƒè¯•æ¨¡å¼è®¾ç½®
        DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
        
        # ä»¥ä¸‹å˜é‡ç”±ç³»ç»Ÿå’Œè„šæœ¬è‡ªåŠ¨å¤„ç†ï¼š
        # - GITHUB_ACTIONS: GitHubè‡ªåŠ¨è®¾ç½®ä¸º"true"
        # - USE_HEADLESS: main.pyæ£€æµ‹åˆ°GITHUB_ACTIONSæ—¶è‡ªåŠ¨å¯ç”¨æ— å¤´æ¨¡å¼
        # - VERIFICATION_TIMEOUT: main.pyé»˜è®¤180ç§’è¶…æ—¶
      run: |
        echo "ğŸš€ å¯åŠ¨XServer GAMEå®Œå…¨è‡ªåŠ¨åŒ–ç™»å½•æµç¨‹..."
        echo "ğŸ“§ XServeré‚®ç®±: $XSERVER_EMAIL"
        echo "ğŸ“® éªŒè¯é‚®ç®±: $WEBMAIL_USERNAME@zmkk.edu.kg"
        echo "ğŸ¤– è¿è¡Œç¯å¢ƒ: GitHub Actions (è‡ªåŠ¨æ— å¤´æ¨¡å¼)"
        echo "â° éªŒè¯ç è·å–è¶…æ—¶: 180ç§’"
        echo "ğŸ› è°ƒè¯•æ¨¡å¼: $DEBUG_MODE"
        echo "ğŸ“‚ å·¥ä½œç›®å½•: $(pwd)"
        echo "ğŸ Pythonç‰ˆæœ¬: $(python --version)"
        echo ""
        
        # æ£€æŸ¥å¿…è¦çš„è„šæœ¬æ–‡ä»¶
        echo "ğŸ“‹ æ£€æŸ¥è„šæœ¬æ–‡ä»¶ï¼š"
        ls -la *.py
        echo ""
        
        # è¿è¡Œä¸»æ§è„šæœ¬ï¼Œå®ç°login.pyå’Œcode.pyçš„å®Œå…¨è‡ªåŠ¨åŒ–è”åŠ¨
        python main.py
        
    - name: ğŸ“¸ ä¸Šä¼ è¿è¡Œç»“æœ
      if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¸Šä¼ 
      uses: actions/upload-artifact@v4
      with:
        name: xserver-auto-login-results-${{ github.run_number }}
        path: |
          *.png
          *.log
          *.txt
        retention-days: 7  # ä¿ç•™7å¤©
        
    - name: ğŸ“‹ æ˜¾ç¤ºè¿è¡Œç»“æœ
      if: always()
      run: |
        echo "=== XServer GAME å®Œå…¨è‡ªåŠ¨åŒ–ç™»å½•ä»»åŠ¡å®Œæˆ ==="
        echo ""
        echo "ğŸ“¸ ç”Ÿæˆçš„æˆªå›¾æ–‡ä»¶ï¼š"
        ls -la *.png 2>/dev/null || echo "   æ— æˆªå›¾æ–‡ä»¶"
        echo ""
        echo "ğŸ“‹ ç”Ÿæˆçš„æ—¥å¿—æ–‡ä»¶ï¼š"
        ls -la *.log 2>/dev/null || echo "   æ— æ—¥å¿—æ–‡ä»¶"
        echo ""
        echo "ğŸ“„ ç”Ÿæˆçš„æ–‡æœ¬æ–‡ä»¶ï¼š"
        ls -la *.txt 2>/dev/null || echo "   æ— æ–‡æœ¬æ–‡ä»¶"
        echo ""
        echo "ğŸ” main.pyæ‰§è¡Œé€€å‡ºç : $?"
        echo ""
        echo "ğŸ“ å®Œæ•´å·¥ä½œç›®å½•å†…å®¹ï¼š"
        ls -la

    - name: ğŸ§¹ æ¸…ç†æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
      uses: MajorScruffy/delete-old-workflow-runs@v0.3.0
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        repository: ${{ github.repository }}
        older-than-seconds: 172800  # åˆ é™¤2å¤©å‰çš„è®°å½•
